<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artifact Classification System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --gradient-start: #6a11cb;
            --gradient-end: #2575fc;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            color: white;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            color: var(--dark-color);
        }
        
        header {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            margin-bottom: 0;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .model-info {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 8px;
            margin-top: 15px;
            display: inline-block;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            padding: 30px;
            margin-bottom: 0;
        }
        
        .upload-section, .camera-section {
            flex: 1;
            min-width: 300px;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }
        
        .upload-section:hover, .camera-section:hover {
            transform: translateY(-5px);
        }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .upload-area {
            border: 2px dashed var(--secondary-color);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .upload-area:hover {
            background-color: rgba(52, 152, 219, 0.1);
            border-color: var(--primary-color);
        }
        
        .upload-icon {
            font-size: 3.5rem;
            color: var(--secondary-color);
            margin-bottom: 15px;
        }
        
        .file-input {
            display: none;
        }
        
        .camera-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .camera-feed {
            width: 100%;
            height: 300px;
            background-color: #f0f0f0;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 1px solid #ddd;
        }
        
        .camera-placeholder {
            color: #777;
            text-align: center;
            padding: 20px;
        }
        
        .camera-feed img, .camera-feed video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 25px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn-capture {
            background-color: var(--accent-color);
            width: 100%;
        }
        
        .btn-capture:hover {
            background-color: #c0392b;
        }
        
        .btn-camera {
            flex: 1;
            background-color: var(--success-color);
        }
        
        .btn-camera.off {
            background-color: #7f8c8d;
        }
        
        .btn-download {
            background-color: var(--success-color);
        }
        
        .btn-download:hover {
            background-color: #27ae60;
        }
        
        .btn-speak {
            background-color: var(--warning-color);
        }
        
        .btn-speak:hover {
            background-color: #e67e22;
        }
        
        .btn-stop {
            background-color: var(--accent-color);
        }
        
        .btn-stop:hover {
            background-color: #c0392b;
        }
        
        .results-section {
            background: white;
            padding: 30px;
            margin-bottom: 0;
        }
        
        .results-content {
            display: none;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 900px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .prediction-chart {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .prediction-item {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .prediction-label {
            min-width: 150px;
            font-weight: 600;
        }
        
        .prediction-bar-container {
            flex-grow: 1;
            height: 28px;
            background-color: #eee;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .prediction-bar {
            height: 100%;
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            border-radius: 14px;
            transition: width 0.8s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 15px;
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .confidence-chart-container {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .chart-title {
            text-align: center;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .artifact-details {
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            border-left: 4px solid var(--secondary-color);
            grid-column: 1 / -1;
            margin-top: 20px;
        }
        
        .detail-item {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .detail-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .detail-label {
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .tts-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--secondary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            color: var(--accent-color);
            text-align: center;
            padding: 15px;
            background-color: rgba(231, 76, 60, 0.1);
            border-radius: 6px;
            margin-top: 15px;
            display: none;
            border-left: 4px solid var(--accent-color);
        }
        
        .success-message {
            color: var(--success-color);
            text-align: center;
            padding: 15px;
            background-color: rgba(46, 204, 113, 0.1);
            border-radius: 6px;
            margin-top: 15px;
            display: none;
            border-left: 4px solid var(--success-color);
        }
        
        .server-status {
            text-align: center;
            margin-top: 15px;
            font-size: 0.9rem;
            padding: 10px;
            border-radius: 6px;
            background-color: rgba(236, 240, 241, 0.5);
        }
        
        .status-online {
            color: var(--success-color);
            font-weight: 600;
        }
        
        .status-offline {
            color: var(--accent-color);
            font-weight: 600;
        }
        
        .troubleshooting {
            background-color: #fff4e6;
            border-left: 4px solid var(--warning-color);
            padding: 20px;
            margin: 20px 0;
            border-radius: 6px;
        }
        
        .troubleshooting h3 {
            color: var(--warning-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .troubleshooting ul {
            margin-left: 20px;
            margin-bottom: 10px;
        }
        
        .troubleshooting li {
            margin-bottom: 8px;
        }
        
        footer {
            text-align: center;
            padding: 25px;
            color: #7f8c8d;
            font-size: 0.9rem;
            background-color: #f8f9fa;
            border-top: 1px solid #eaeaea;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .camera-controls {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .tts-controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }

        .demo-results {
            display: none;
            margin-top: 20px;
        }
        
        .accuracy-badge {
            display: inline-block;
            padding: 5px 10px;
            background-color: var(--success-color);
            color: white;
            border-radius: 4px;
            font-weight: 600;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-monument"></i> Artifact Classification</h1>
            <p class="subtitle">Upload an image or use your camera to identify archaeological artifacts</p>
            <div class="model-info">
                <i class="fas fa-brain"></i> Model: EfficientNet-V2 | Accuracy: <span id="modelAccuracy">Loading...</span>
            </div>
        </header>
        
        <div class="main-content">
            <div class="upload-section">
                <h2 class="section-title"><i class="fas fa-upload"></i> Upload Image</h2>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                    <p>Click to browse or drag and drop an image</p>
                    <p><small>(Supported formats: JPG, PNG, WEBP)</small></p>
                    <input type="file" class="file-input" id="fileInput" accept="image/*">
                </div>
                <button class="btn" id="demoBtn">
                    <i class="fas fa-magic"></i> Try Demo
                </button>
                <div class="error-message" id="uploadError"></div>
            </div>
            
            <div class="camera-section">
                <h2 class="section-title"><i class="fas fa-camera"></i> Use Camera</h2>
                <div class="camera-controls">
                    <button class="btn btn-camera" id="cameraToggle"><i class="fas fa-play"></i> Start Camera</button>
                </div>
                <div class="camera-feed" id="cameraFeed">
                    <div class="camera-placeholder" id="cameraPlaceholder">
                        <i class="fas fa-camera-slash" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <p>Camera is off. Click "Start Camera" to enable.</p>
                    </div>
                    <video id="cameraVideo" autoplay playsinline style="display: none;"></video>
                    <img src="" id="cameraImage" style="display: none;">
                </div>
                <button class="btn btn-capture" id="captureBtn" disabled><i class="fas fa-camera"></i> Capture & Analyze</button>
                <div class="error-message" id="cameraError"></div>
                <div class="server-status" id="serverStatus">
                    Server status: <span class="status-offline" id="statusText">Checking...</span>
                </div>
            </div>
        </div>
        
        <div class="results-section">
            <h2 class="section-title"><i class="fas fa-chart-bar"></i> Analysis Results</h2>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Analyzing artifact...</p>
            </div>
            
            <div class="results-content" id="resultsContent">
                <div class="results-grid">
                    <div class="prediction-results">
                        <h3>Classification Results</h3>
                        <div class="prediction-chart" id="predictionChart">
                            <!-- Prediction bars will be inserted here -->
                        </div>
                    </div>
                    
                    <div class="confidence-chart-container">
                        <div class="chart-title">Confidence Distribution</div>
                        <div class="confidence-chart" id="confidenceChart">
                            <p>Chart will appear here when server is connected</p>
                        </div>
                        <p class="chart-caption">This chart shows the model's confidence across all artifact classes.</p>
                    </div>
                </div>
                
                <div class="artifact-details" id="artifactDetails">
                    <!-- Artifact details will be inserted here -->
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-download" id="downloadReport"><i class="fas fa-download"></i> Download Report</button>
                    <div class="tts-controls">
                        <button class="btn btn-speak" id="speakBtn"><i class="fas fa-volume-up"></i> Speak Results</button>
                        <button class="btn btn-stop" id="stopSpeakBtn" style="display: none;"><i class="fas fa-stop"></i> Stop Speaking</button>
                    </div>
                </div>
            </div>

            <div class="demo-results" id="demoResults">
                <div class="troubleshooting">
                    <h3><i class="fas fa-info-circle"></i> Demo Mode Active</h3>
                    <p>You're currently viewing demo data because the server is not responding. To fix this:</p>
                    <ul>
                        <li>Ensure your Flask server is running on http://localhost:3000</li>
                        <li>Check that all required Python packages are installed</li>
                        <li>Verify that the model file 'artifact_with_val.pth' is in the correct location</li>
                    </ul>
                </div>
                
                <div class="results-grid">
                    <div class="prediction-results">
                        <h3>Classification Results (Demo)</h3>
                        <div class="prediction-chart">
                            <div class="prediction-item">
                                <div class="prediction-label">Pottery</div>
                                <div class="prediction-bar-container">
                                    <div class="prediction-bar" style="width: 85%;">85.0%</div>
                                </div>
                            </div>
                            <div class="prediction-item">
                                <div class="prediction-label">Shell Bangle</div>
                                <div class="prediction-bar-container">
                                    <div class="prediction-bar" style="width: 65%; background-color: var(--chart-color-4);">65.0%</div>
                                </div>
                            </div>
                            <div class="prediction-item">
                                <div class="prediction-label">Kendi</div>
                                <div class="prediction-bar-container">
                                    <div class="prediction-bar" style="width: 45%; background-color: var(--chart-color-2);">45.0%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="confidence-chart-container">
                        <div class="chart-title">Confidence Distribution</div>
                        <div class="confidence-chart">
                            <p>Demo confidence chart (server offline)</p>
                        </div>
                    </div>
                </div>
                
                <div class="artifact-details">
                    <h3>Pottery</h3>
                    <div class="detail-item">
                        <div class="detail-label"><i class="fas fa-align-left"></i> Description</div>
                        <div>Ceramic ware made from fired clay. This is one of the most common types of artifacts found, encompassing everything from simple storage jars and cooking pots to elaborately decorated ceremonial vessels.</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label"><i class="fas fa-history"></i> Historical Era</div>
                        <div>From the Neolithic period (c. 10,000 BCE) onwards. It is a defining characteristic of this period.</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label"><i class="fas fa-cube"></i> Material</div>
                        <div>Fired clay, which may be mixed with tempering agents like sand, shell, or crushed rock to prevent cracking.</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label"><i class="fas fa-star"></i> Significance</div>
                        <div>Pottery is invaluable for archaeologists. Its style, shape, and decoration are primary tools for dating sites and identifying different cultural groups. Chemical analysis can even reveal what the pots were used to store.</div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-download"><i class="fas fa-download"></i> Download Report</button>
                    <div class="tts-controls">
                        <button class="btn btn-speak"><i class="fas fa-volume-up"></i> Speak Results</button>
                        <button class="btn btn-stop" style="display: none;"><i class="fas fa-stop"></i> Stop Speaking</button>
                    </div>
                </div>
            </div>
            
            <div class="error-message" id="resultsError"></div>
            <div class="success-message" id="successMessage"></div>
        </div>
        
        <div class="troubleshooting">
            <h3><i class="fas fa-tools"></i> Server Connection Troubleshooting</h3>
            <p>If you're experiencing server errors (500), try these steps:</p>
            <ul>
                <li>Ensure Flask is installed: <code>pip install flask</code></li>
                <li>Install required packages: <code>pip install torch torchvision Pillow matplotlib</code></li>
                <li>Check that the model file 'artifact_with_val.pth' is in the correct location</li>
                <li>Verify the server is running on port 3000: <code>flask run --port=3000</code></li>
                <li>Check the console for any error messages</li>
            </ul>
        </div>
        
        <footer>
            <p>Artifact Classification System &copy; 2023</p>
            <p>Model: EfficientNet-V2 | Accuracy: <span id="footerAccuracy">Loading...</span></p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const cameraToggle = document.getElementById('cameraToggle');
            const captureBtn = document.getElementById('captureBtn');
            const cameraFeed = document.getElementById('cameraFeed');
            const cameraImage = document.getElementById('cameraImage');
            const cameraPlaceholder = document.getElementById('cameraPlaceholder');
            const loading = document.getElementById('loading');
            const resultsContent = document.getElementById('resultsContent');
            const predictionChart = document.getElementById('predictionChart');
            const confidenceChart = document.getElementById('confidenceChart');
            const artifactDetails = document.getElementById('artifactDetails');
            const uploadError = document.getElementById('uploadError');
            const cameraError = document.getElementById('cameraError');
            const resultsError = document.getElementById('resultsError');
            const successMessage = document.getElementById('successMessage');
            const serverStatus = document.getElementById('serverStatus');
            const statusText = document.getElementById('statusText');
            const downloadReport = document.getElementById('downloadReport');
            const speakBtn = document.getElementById('speakBtn');
            const stopSpeakBtn = document.getElementById('stopSpeakBtn');
            const demoBtn = document.getElementById('demoBtn');
            const demoResults = document.getElementById('demoResults');
            const modelAccuracy = document.getElementById('modelAccuracy');
            const footerAccuracy = document.getElementById('footerAccuracy');
            
            // State variables
            let isCameraOn = false;
            let stream = null;
            let currentResults = null;
            let speechSynthesis = window.speechSynthesis;
            let isSpeaking = false;
            
            // Check server status on page load
            checkServerStatus();
            
            // Event listeners
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);
            cameraToggle.addEventListener('click', toggleCamera);
            captureBtn.addEventListener('click', captureImage);
            downloadReport.addEventListener('click', handleDownloadReport);
            speakBtn.addEventListener('click', handleSpeak);
            stopSpeakBtn.addEventListener('click', handleStopSpeak);
            demoBtn.addEventListener('click', showDemoResults);
            
            // Functions
            function handleDragOver(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.style.backgroundColor = 'rgba(52, 152, 219, 0.2)';
            }
            
            function handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.style.backgroundColor = '';
                
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    handleFile(e.dataTransfer.files[0]);
                }
            }
            
            function handleFileSelect(e) {
                if (e.target.files && e.target.files[0]) {
                    handleFile(e.target.files[0]);
                }
            }
            
            function handleFile(file) {
                // Reset errors and demo
                hideErrors();
                demoResults.style.display = 'none';
                
                // Check if file is an image
                if (!file.type.match('image.*')) {
                    showError(uploadError, 'Please select an image file');
                    return;
                }
                
                // Check file size (25MB limit)
                if (file.size > 25 * 1024 * 1024) {
                    showError(uploadError, 'File size exceeds 25MB limit');
                    return;
                }
                
                // Send to server for prediction
                uploadImage(file);
            }
            
            async function toggleCamera() {
                if (isCameraOn) {
                    // Turn camera off
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                        stream = null;
                    }
                    cameraImage.style.display = 'none';
                    cameraPlaceholder.style.display = 'block';
                    cameraToggle.innerHTML = '<i class="fas fa-play"></i> Start Camera';
                    cameraToggle.classList.remove('off');
                    captureBtn.disabled = true;
                    isCameraOn = false;
                } else {
                    // Turn camera on
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { width: 1280, height: 720 } 
                        });
                        
                        // Create a video element to display the stream
                        if (!document.getElementById('cameraVideo')) {
                            const video = document.createElement('video');
                            video.id = 'cameraVideo';
                            video.autoplay = true;
                            video.playsInline = true;
                            cameraFeed.appendChild(video);
                        }
                        
                        const video = document.getElementById('cameraVideo');
                        video.srcObject = stream;
                        
                        cameraPlaceholder.style.display = 'none';
                        video.style.display = 'block';
                        cameraToggle.innerHTML = '<i class="fas fa-stop"></i> Stop Camera';
                        cameraToggle.classList.add('off');
                        captureBtn.disabled = false;
                        isCameraOn = true;
                    } catch (err) {
                        showError(cameraError, 'Error accessing camera: ' + err.message);
                    }
                }
            }
            
            function captureImage() {
                // Reset errors and demo
                hideErrors();
                demoResults.style.display = 'none';
                
                const video = document.getElementById('cameraVideo');
                if (!video || !isCameraOn) {
                    showError(cameraError, 'Camera is not available');
                    return;
                }
                
                // Create a canvas to capture the current frame
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // Draw the current video frame to the canvas
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Convert canvas to blob and send to server
                canvas.toBlob(function(blob) {
                    uploadImage(blob);
                }, 'image/jpeg', 0.8);
            }
            
            function uploadImage(file) {
                // Show loading state
                loading.style.display = 'block';
                resultsContent.style.display = 'none';
                
                // Create form data
                const formData = new FormData();
                formData.append('image', file);
                
                // Send to server
                fetch('/predict', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Server error: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // Store results for download
                    currentResults = data;
                    
                    // Display results
                    displayResults(data);
                    
                    // Show success message
                    showSuccess('Analysis completed successfully!');
                    
                    // Update server status
                    statusText.textContent = 'Online';
                    statusText.className = 'status-online';
                    
                    // Update model accuracy if provided
                    if (data.model_accuracy) {
                        modelAccuracy.textContent = (data.model_accuracy * 100).toFixed(2) + '%';
                        footerAccuracy.textContent = (data.model_accuracy * 100).toFixed(2) + '%';
                    }
                })
                .catch(error => {
                    showError(resultsError, 'Error: ' + error.message);
                    
                    // Update server status
                    statusText.textContent = 'Offline';
                    statusText.className = 'status-offline';
                })
                .finally(() => {
                    loading.style.display = 'none';
                });
            }
            
            function displayResults(data) {
                // Clear previous results
                predictionChart.innerHTML = '';
                artifactDetails.innerHTML = '';
                
                // Display prediction chart
                if (data.top_k && data.top_k.length > 0) {
                    data.top_k.forEach(item => {
                        const predictionItem = document.createElement('div');
                        predictionItem.className = 'prediction-item';
                        
                        const label = document.createElement('div');
                        label.className = 'prediction-label';
                        label.textContent = item.class;
                        
                        const barContainer = document.createElement('div');
                        barContainer.className = 'prediction-bar-container';
                        
                        const bar = document.createElement('div');
                        bar.className = 'prediction-bar';
                        bar.style.width = '0%'; // Start at 0 for animation
                        bar.textContent = (item.probability * 100).toFixed(2) + '%';
                        
                        // Different colors for different confidence levels
                        if (item.probability > 0.7) {
                            bar.style.backgroundColor = 'var(--success-color)';
                        } else if (item.probability > 0.4) {
                            bar.style.backgroundColor = 'var(--warning-color)';
                        } else {
                            bar.style.backgroundColor = 'var(--accent-color)';
                        }
                        
                        barContainer.appendChild(bar);
                        predictionItem.appendChild(label);
                        predictionItem.appendChild(barContainer);
                        
                        predictionChart.appendChild(predictionItem);
                        
                        // Animate the bar
                        setTimeout(() => {
                            bar.style.width = (item.probability * 100) + '%';
                        }, 100);
                    });
                }
                
                // Display confidence chart if available
                if (data.chart_url) {
                    confidenceChart.innerHTML = `<img src="${data.chart_url}?t=${new Date().getTime()}" alt="Confidence Chart" style="width: 100%; height: 100%; object-fit: contain;">`;
                }
                
                // Display artifact details
                if (data.details) {
                    const details = data.details;
                    
                    const title = document.createElement('h3');
                    title.textContent = data.top1.class;
                    artifactDetails.appendChild(title);
                    
                    if (details.description) {
                        addDetailItem(artifactDetails, 'Description', details.description);
                    }
                    
                    if (details.era) {
                        addDetailItem(artifactDetails, 'Historical Era', details.era);
                    }
                    
                    if (details.material) {
                        addDetailItem(artifactDetails, 'Material', details.material);
                    }
                    
                    if (details.significance) {
                        addDetailItem(artifactDetails, 'Significance', details.significance);
                    }
                }
                
                // Set up download link
                if (data.report_url) {
                    downloadReport.href = data.report_url;
                    downloadReport.style.display = 'inline-flex';
                } else {
                    downloadReport.style.display = 'none';
                }
                
                // Show TTS controls
                speakBtn.style.display = 'inline-flex';
                
                // Show results section
                resultsContent.style.display = 'block';
            }
            
            function addDetailItem(container, label, value) {
                const item = document.createElement('div');
                item.className = 'detail-item';
                
                const labelEl = document.createElement('div');
                labelEl.className = 'detail-label';
                
                // Add icon based on label
                let iconClass = 'fas fa-info-circle';
                if (label === 'Description') iconClass = 'fas fa-align-left';
                if (label === 'Historical Era') iconClass = 'fas fa-history';
                if (label === 'Material') iconClass = 'fas fa-cube';
                if (label === 'Significance') iconClass = 'fas fa-star';
                
                labelEl.innerHTML = `<i class="${iconClass}"></i> ${label}`;
                
                const valueEl = document.createElement('div');
                valueEl.textContent = value;
                
                item.appendChild(labelEl);
                item.appendChild(valueEl);
                container.appendChild(item);
            }
            
            function handleDownloadReport(e) {
                if (!currentResults || !currentResults.report_url) {
                    e.preventDefault();
                    showError(resultsError, 'No report available for download');
                }
            }
            
            function handleSpeak() {
                if (!currentResults || !currentResults.text_to_speech) {
                    showError(resultsError, 'No text available for speech');
                    return;
                }
                
                if (isSpeaking) {
                    handleStopSpeak();
                    return;
                }
                
                // Create speech synthesis utterance
                const utterance = new SpeechSynthesisUtterance(currentResults.text_to_speech);
                
                // Set up event listeners
                utterance.onend = function() {
                    isSpeaking = false;
                    speakBtn.innerHTML = '<i class="fas fa-volume-up"></i> Speak Results';
                    stopSpeakBtn.style.display = 'none';
                };
                
                utterance.onerror = function() {
                    isSpeaking = false;
                    speakBtn.innerHTML = '<i class="fas fa-volume-up"></i> Speak Results';
                    stopSpeakBtn.style.display = 'none';
                    showError(resultsError, 'Error with text-to-speech');
                };
                
                // Start speaking
                speechSynthesis.speak(utterance);
                isSpeaking = true;
                speakBtn.innerHTML = '<i class="fas fa-pause"></i> Pause Speaking';
                stopSpeakBtn.style.display = 'inline-flex';
            }
            
            function handleStopSpeak() {
                speechSynthesis.cancel();
                isSpeaking = false;
                speakBtn.innerHTML = '<i class="fas fa-volume-up"></i> Speak Results';
                stopSpeakBtn.style.display = 'none';
            }
            
            function showDemoResults() {
                // Hide any errors and current results
                hideErrors();
                resultsContent.style.display = 'none';
                loading.style.display = 'none';
                
                // Show demo results
                demoResults.style.display = 'block';
                
                // Show success message
                showSuccess('Demo results loaded. Connect to server for real analysis.');
            }
            
            function showError(element, message) {
                element.textContent = message;
                element.style.display = 'block';
                
                // Hide after 5 seconds
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
            
            function showSuccess(message) {
                successMessage.textContent = message;
                successMessage.style.display = 'block';
                
                // Hide after 5 seconds
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 5000);
            }
            
            function hideErrors() {
                uploadError.style.display = 'none';
                cameraError.style.display = 'none';
                resultsError.style.display = 'none';
                successMessage.style.display = 'none';
            }
            
            function checkServerStatus() {
                // Try to fetch from server to check if it's running
                fetch('/predict', {
                    method: 'HEAD'
                })
                .then(response => {
                    statusText.textContent = 'Online';
                    statusText.className = 'status-online';
                    
                    // If server is online, try to get model info
                    fetch('/model-info')
                        .then(response => response.json())
                        .then(data => {
                            if (data.accuracy) {
                                modelAccuracy.textContent = (data.accuracy * 100).toFixed(2) + '%';
                                footerAccuracy.textContent = (data.accuracy * 100).toFixed(2) + '%';
                            }
                        })
                        .catch(() => {
                            // If model info is not available, use placeholder
                            modelAccuracy.textContent = '92.75%';
                            footerAccuracy.textContent = '92.75%';
                        });
                })
                .catch(error => {
                    statusText.textContent = 'Offline';
                    statusText.className = 'status-offline';
                    showError(resultsError, 'Server is not responding. Make sure the Flask server is running on http://localhost:3000');
                    
                    // Use placeholder accuracy when offline
                    modelAccuracy.textContent = '92.75%';
                    footerAccuracy.textContent = '92.75%';
                });
            }
        });
    </script>
</body>
</html>